name: GitHub Actions Pipeline Math Utils App

on:
  push:
    branches:
      - '**'
  pull_request:

env:
  AWS_REGION: us-east-1
  ECS_SERVICE: MathUtilsApp-Service
  ECS_CLUSTER: Mathutils
  ECS_TASK_DEFINITION: MathUtilsApp           
  CONTAINER_NAME: App
  DOCKERHUB_USERNAME: anacarolr

permissions:
  contents: read

jobs:
  pipeline:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Set up Node.js
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3) Install Node.js dependencies
      - name: Install dependencies
        if: hashFiles('package.json') != ''
        run: npm install

      # 4) Run MathUtils test script (test2.js)
      - name: Run MathUtils test script
        run: node test2.js

      # 5) Scan source code with Trivy (filesystem scan)
      - name: Run Trivy vulnerability scanner on code
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'HIGH,CRITICAL'

      # 6) Build Docker image
      - name: Build Docker image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/task3-app:${IMAGE_TAG} .

      # 7) Scan built Docker image with Trivy (image scan)
      - name: Scan Docker image
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: '${{ secrets.DOCKERHUB_USERNAME }}/task3-app:${{ github.sha }}'
          format: 'table'
          severity: 'HIGH,CRITICAL'

      # 8) Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 9) Push image to Docker Hub
      - name: Push Docker image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/task3-app:${IMAGE_TAG}

      # 10) Configure AWS credentials (for ECS deploy)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 11) Download current task definition from ECS
      - name: Download current task definition from ECS
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --query taskDefinition > task-definition-raw.json

      # 12) Clean task definition JSON (remove unsupported metadata keys)
      - name: Clean task definition JSON
        run: |
          cat task-definition-raw.json \
            | jq 'del(
                .compatibilities,
                .taskDefinitionArn,
                .requiresAttributes,
                .revision,
                .status,
                .registeredAt,
                .registeredBy,
                .enableFaultInjection
              )' > task-definition.json

      # 13) Fill in the new Docker Hub image in the Amazon ECS task definition
      - name: Render Amazon ECS task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ env.DOCKERHUB_USERNAME }}/task3-app:${{ github.sha }}

      # 14) Deploy Amazon ECS task definition
      - name: Deploy Amazon ECS task definition
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
